---
title: "FEがWordPressを攻略する #2 ── アーカイブ、本文ページの作成"
date: "20210427"
tags: ["プログラミング", "WordPress"]
thumbnail: "thumbnail.png"
---

## 全体の目次

この記事は第2回目の記事となる。

### [第1回](../wordpress-introduction1/)

- はじめに
- ローカル環境を用意する
- デフォルトテーマを剥がして無のテーマを作る
- 「固定ページ」と「投稿」と「カスタム投稿タイプ」の解説
- カスタム投稿タイプの作成

### 第2回（この記事）

- カスタム投稿タイプごとに「一覧ページ」と「本文ページ」を作る
- 「実績紹介」ページにカスタムフィールド「サムネイル」を追加する

### [第3回](../wordpress-introduction3/)

- 固定ページの作成方法を解説
- デフォルトの「投稿」を含む、各種投稿タイプの挙動について解説
- 細かい調整とスタイリングを行い、サイトの完成形を紹介

## 「記事一覧ページ」「本文ページ」の作り方

ここからは、前回の記事で作成したカスタム投稿タイプ「実績紹介」「ニュース」に対して、

- 投稿した記事を一覧表示する「アーカイブ」ページ
- 記事の本文ページ

を作成する。当然ながら、これらはデータベースに保存された記事データを**動的に取得してくる**必要があるため、phpを用いて記述を行うことになる。

WordPressでは、下記のとおり「アーカイブページ」「記事本文ページ」のファイル名があらかじめ定められている。

|ファイル名|説明|
|-|-|
|archive-(slug).php|記事一覧ページ|
|single-(slug).php|記事本文ページ|

上記の`slug`の部分にはカスタム投稿タイプの作成時に設定した値が使われる。今回の場合、

### 実績紹介

- archive-works.php
- single-works.php

### ニュース

- archive-news.php
- single-news.php

という名前にすればよい。


## 適当な記事を投稿する

まずは読み込みが正常に行われていることを確認するために、「実績紹介」「ニュース」にそれぞれ2つ程度記事を投稿しておこう。

![投稿例1](./01.png)

![投稿例2](./02.png)

## 「ニュース」を作成する

これから「ニュース」のアーカイブページを作成していく。テーマフォルダ内（index.phpなどと同階層）にファイルを追加しよう。

### archive-news.php の作成

```php
<?php get_header() ?>
<div>
    <h1><?php the_archive_title(); ?></h1>
    <?php if(have_posts()): ?>
    <ul>
        <?php while(have_posts()):the_post(); ?>
            <li>
                <span><?php the_time('Y/m/d'); ?></span>
                <h2><a href="<?php the_permalink(); ?>"><?php the_title(); ?></a>
            </li>
        <?php endwhile; ?>
    </ul>
    <?php endif; ?>
</div>
<?php get_footer() ?>
```

例によって最小限の記述としている。`while`文を用いて記事の数だけ`<li>`以下を出力しているのがポイントだ。JSに慣れていると少々クセのあるループ文の書き方だが、こればかりは慣れるしかない。

それほど難しい内容はないが、組み込み関数の内容は下記のとおり。

|関数|説明|
|-|-|
|the\_archive\_title()|アーカイブのタイトル。今回の場合は「ニュース」。|
|have_posts()|記事の存在判定。
|the_time()|記事の投稿日。|
|the_permalink()|記事本文ページのパーマリンクURL。|
|the_title()|記事のタイトル。|

### パーマリンクの設定を更新する

archive-(slug).phpを作成すると、`(サイトのドメイン)/(slug)/`というURLでアーカイブページが作成される。

しかし、WordPressを利用する上で絶対に覚えておきたい点として、「**パーマリンクが追加、変更された際にすぐに設定が反映されない場合がある**」ことに注意しよう。

WordPressはサーバーにパーマリンクのキャッシュを保存しているため、「追加、変更したはずのページにアクセスできない」ということが度々起こる。ちょっと面倒だが、怪しいと思ったら

- 「ダッシュボード」→「設定」→「パーマリンク設定」で、設定は何も変更せずに「変更を保存」ボタンを押す

という手順でパーマリンクの更新を行ってみるとよい。

![パーマリンクの更新](./03.png)

### アーカイブの表示を確認する

パーマリンクを更新したら、`(サイトのドメイン)/news/`にアクセスしてみよう。投稿した記事が動的に取得され、リンクが表示されていることがわかる。

![アーカイブページ](./04.png)

### single-news.php の作成

これだけだと、リンクをクリックしても記事の内容は表示されない。続いて、記事の本文を表示するためのphpファイルを作成する。

```php
<?php get_header() ?>
<article>
    <span><?php the_time('Y/m/d'); ?></span>
    <h1><?php the_title(); ?></h1>
    <div>
        <?php the_content(); ?>
    </div>
</article>
<?php get_footer() ?>
```

こちらも記述は最低限としている。

|関数|説明|
|-|-|
|the_content()|記事の本文。|

以上でニュースの本文にアクセスできるようになったので、アーカイブページから記事のリンクをクリックしてみよう。下記のように記事本文ページが表示されれば成功だ。

![記事ページ](./05.png)

### 記事本文のパーマリンクを設定する

デフォルトでは記事のパーマリンクは**記事のタイトルと同様**となるため、日本語のタイトルをつけている場合は`(サイトのドメイン)/news/%e5%bc%8a%e7%a4……(省略)/`のように日本語がエンコードされたURLになってしまう。これだと見た目もわかりづらく、SEO観点でもあまり好ましくないだろう。

そこで、投稿の編集画面からパーマリンクを変更する。

![記事パーマリンクの変更](./06.png)

編集画面上部でパーマリンクを変更し「公開」すると、`(サイトのドメイン)/news/abc/`のように設定したURLで記事にアクセスできるようになる。もし設定がうまく反映されない場合は、先述のパーマリンク設定の更新も試してみるとよい。

以上の手順で、「ニュース一覧ページ」「ニュース記事本文ページ」を作成することができた。

## 「実績紹介ページ」にカスタムフィールドを設定する

「実績紹介」の作成も基本的な流れは「ニュース」と同様だが、ここで前回の記事で紹介した「**カスタムフィールド**」を利用して実績紹介に追加の入力欄を用意してみよう。

「実績紹介」は会社のプロダクトを紹介するためのコンテンツなので、投稿ごとに「サムネイル」があるとよりわかりやすくなるだろう。そこで、今回は画像を入力できるカスタムフィールド「サムネイル」を追加してみる。

まず、現在はWordPressのもっとも基本的なデータ構造である

- タイトル
- 本文

のみが入力フィールドとして存在している。

![実績紹介ページの入力欄](./07.png)

ここに「サムネイル」という項目を追加するためには、カスタム投稿タイプと同様に

- functions.phpを編集する
- 外部プラグインを利用する

2つの方法がある。今回は理解を深める目的も兼ねて、前者の方法で進めていこう。

```php
```

見てのとおり、比較的簡単だったカスタム投稿タイプの追加と比べるとかなりコードがややこしい。前提として、カスタムフィールドの追加時は

- カスタムフィールドの「入力欄」そのものを自前で実装する必要がある（そのぶん、慣れれば自由度は高い）
- 値を保存する際のハンドリングも自分で行う必要がある

という点に注意。順を追って解説していくが、ここに関しては外部プラグインの導入を検討してもよいかもしれない。

執筆中

### おわりに

以上で「カスタム投稿タイプ」の内容を表示することができるようになった。

最終回となる次回記事では、

- 固定ページの作成方法を解説
- デフォルトの「投稿」を含む、各種投稿タイプのパーマリンクの挙動について解説
- スタイリングを行い、サイト完成形を紹介

を行う。
